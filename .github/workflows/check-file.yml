name: Check & Version File

permissions:
  contents: write   # <— wichtig für git push

on:
  schedule:
    - cron: "0 * * * *"   # stündlich
  workflow_dispatch:        # manuell startbar

jobs:
  fetch:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          persist-credentials: true
          fetch-depth: 0

      - name: Download fixtures.csv
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p fixtures
          curl -fSL "https://www.football-data.co.uk/fixtures.csv" -o fixtures/fixtures.csv

      - name: Download Country Files into league folders
        shell: bash
        run: |
          set -euo pipefail
          season="2526"
          # Alle gewünschten Ligen – einfach hier ergänzen/entfernen
          leagues=(E0 E1 E2 E3 D1 D2 F1 F2 I1 I2 P1 SP1 SP2 T1)

          mkdir -p CountryFiles
          for lg in "${leagues[@]}"; do
            mkdir -p "CountryFiles/${lg}"
            url="https://www.football-data.co.uk/mmz4281/${season}/${lg}.csv"
            # lädt z. B. nach CountryFiles/E0/E0.csv
            curl -fSL "$url" -o "CountryFiles/${lg}/${lg}.csv"
          done

      - name: Commit if changed (only changed files get dated copies)
        shell: bash
        run: |
          set -euo pipefail
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"

          # Welche Dateien haben sich wirklich geändert oder sind neu?
          # Bezieht nur fixtures und CountryFiles ein (PlayoffCountries wird ignoriert)
          mapfile -t changed < <(git status --porcelain \
            | awk '/^( M|A |??) / {print $2}' \
            | grep -E '^(fixtures/fixtures\.csv|CountryFiles/.+\.csv)$' || true)

          if [ "${#changed[@]}" -gt 0 ]; then
            DATE=$(date -u +'%Y-%m-%d')

            # Für jede geänderte Datei eine datierte Kopie erzeugen
            for f in "${changed[@]}"; do
              if [[ "$f" == "fixtures/fixtures.csv" ]]; then
                cp --parents "$f" "fixtures/${DATE}_fixtures.csv"
              else
                dir=$(dirname "$f")         # z. B. CountryFiles/E0
                base=$(basename "$f" .csv)  # z. B. E0
                cp "$f" "${dir}/${DATE}_${base}.csv"
              fi
            done

            # Alles adden (nur fixtures & CountryFiles)
            git add fixtures/*.csv CountryFiles/**/**/*.csv CountryFiles/**/*.csv CountryFiles/*.csv 2>/dev/null || true
            git commit -m "Auto-update: ${DATE}"
            git push
          else
            echo "No changes ✅"
          fi
